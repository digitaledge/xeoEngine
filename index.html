<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>SceneJS Nexus - Actor Engine for SceneJS</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <link href="css/common.css" rel="stylesheet"/>
    <link href="css/jquery.terminal.css" rel="stylesheet"/>

    <script src="js/lib/require.js"></script>

    <script src="js/lib/jquery/jquery-lib.1.7.1.min.js"></script>
    <script src="js/lib/jquery/jquery.mousewheel-min.js"></script>
    <script src="js/lib/jquery/jquery.terminal-min.js"></script>
    <script src="js/lib/jquery/jquery.bpopup-0.7.0.min.js"></script>

    <script src="../scenejs3/scenejs/build/scenejs.js"></script>

</head>
<body>


<a href="https://github.com/xeolabs/scenejs-nexus" target="_blank"><img
        style="position: absolute; top: 0; right: 0; border: 0;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
        alt="Fork me on GitHub"></a>


<div id="tilda"></div>

<div id="menu">
    <span id="path-root"><a
            href="https://github.com/xeolabs/scenejs-nexus" target="_other">scenejs-nexus</a>&nbsp;&gt;&nbsp</span><span
        id="path-file">(none)</span>
    <img id="about-button" class="button" src="images/help.png">
    <img id="terminal-button" class="button" src="images/console.png">
</div>

<canvas id="theCanvas"></canvas>

<!-- About dialogue -->

<div id="about">
    <h1>scenejs nexus</h1>

    <h2>SceneJS + actors + JSON-RPC + PubSub</h2>

    <ul>
        <li>actor engine for SceneJS 3.0 with asynchronous JSON-RPC and PubSub messaging patterns</li>
        <li>fork it at <a href="https://github.com/xeolabs/scenejs-nexus" target="_blank">GitHub</a></li>

        <li>written by <a href="http://xeolabs.com" target="_blank">xeolabs</a> on <a href="http://scenejs.org"
                                                                                      target="_blank">SceneJS V3</a>
        </li>

        <li>type '~' to open a command terminal to speak to the nexus
        </li>
        <li>read more on the <a
                href="https://github.com/xeolabs/scenejs-nexus/wiki" target="_blank">wiki</a>
        </li>
    </ul>

    <div id="about-boot-script">
        <p>boot script: <span id="about-boot-script-name"></span></p>
    </div>

    <div id="about-message">
        <h3 class="wait">loading the nexus, just a moment..</h3>
    </div>

</div>

<!-- Task monitor display -->

<div id="nexus-taskmonitor">
</div>

<script>

String.prototype.strip = function (char) {
    return this.replace(new RegExp("^" + char + "*"), '').
            replace(new RegExp(char + "*$"), '');
};


//$.extend_if_has = function (desc, source, array) {
//    for (var i = array.length; i--;) {
//        if (typeof source[array[i]] != 'undefined') {
//            desc[array[i]] = source[array[i]];
//        }
//    }
//    return desc;
//};



/*-----------------------------------------------------------------------------------------------------------------
 * Tilda
 *---------------------------------------------------------------------------------------------------------------*/

(function ($) {

    $.fn.tilda = function (eval, options) {

        if ($('body').data('tilda')) {
            return $('body').data('tilda').terminal;
        }

        this.addClass('tilda');

        options = options || {};

        eval = eval || function (command, term) {
            term.echo("you don't set eval for tilda");
        };

        var settings = {
            prompt:'ready> ',
            name:'SceneJS Nexus',
            height:"100%",
            enabled:false,
            greetings:'SceneJS Nexus Terminal\n' +
                    'https://github.com/xeolabs/scenejs-nexus/wiki/Nexus-Terminal\n\n'
        };

        if (options) {
            $.extend(settings, options);
        }

        this.append('<div class="td"></div>');

        var self = this;

        var td = this.find('.td');


        self.terminal = td.terminal(eval, settings);

        var focus = false;

        this.show = function () {
            self.slideToggle('fast');
            self.terminal.set_command('');
            self.terminal.focus(focus = !focus);
            self.terminal.attr({
                scrollTop:self.terminal.attr("scrollHeight")
            });
        };

        $(document.documentElement).keypress(
                function (e) {
                    if (e.which == 96) {
                        self.show();
                    }
                });

        $("#terminal-button").click(function () {
            self.show();
        });

        self.hide();

        $('body').data('tilda', this);

        return self;
    };
})(jQuery);


/*-----------------------------------------------------------------------------------------------------------------
 *
 *---------------------------------------------------------------------------------------------------------------*/

jQuery(document).ready(
        function ($) {

            requirejs.config({

                //By default load any module IDs from js/lib
                baseUrl:'js/lib',

                //except, if the module ID starts with "app", load it from the js/app directory
                paths:{
                    app:'../app'
                }
            });

            /* Get selected boot script name and path off URL hash. We use the hash so that the full URL to the
             * engine instance can be used a parameter for web service like this:
             * http://htmlpreview.github.com/?https://raw.github.com/xeolabs/scenejs-nexus/master/index.html#script=demos/teapot
             */
            var urlHashParams = getURLHashParams();

            var script = urlHashParams["script"];

            initAbout({
                script:script
            });

            initNexus(
                    function (nexus) {

                        bindNexusErrors(nexus);

                        initTaskMonitor(nexus);

                        initTerminal(nexus, $);

                        initMenu();

                        updateAbout();

                        /* Create the default scene graph. Since we don't specify a 'sceneId'
                         * we are creating the default scene. Other actors that refer to a
                         * scene will refer to this scene when we omit that property on them.
                         */
                        nexus.add({
                            type:"scene",
                            id:"scene",
                            canvasId:"theCanvas"
                        })

                            /* Load boot script when the scene is resolved in the nexus
                             */
                                .whenResolved(function () {
                                    if (script) {

                                        window.nexus = nexus; // Provide nexus to the script

                                        require(["../../content/scripts/" + script],
                                                function () {
                                                    // OK
                                                });
                                    }
                                });
                    });

        });


function getURLHashParams() {
    var hashParams = {};
    var e;
    var a = /\+/g;  // Regex for replacing addition symbol with a space
    var r = /([^&;=]+)=?([^&;]*)/g;
    var d = function (s) {
        return decodeURIComponent(s.replace(a, " "));
    };
    var q = window.location.hash.substring(1);
    while (e = r.exec(q)) {
        hashParams[d(e[1])] = d(e[2]);
    }
    return hashParams;
}


function initNexus(ok) {

    require([ // SceneJS core

        'scenejs/scenejs.sphere', // TODO: how to lazy-load these from RPC?
        'scenejs/scenejs.teapot',
        'scenejs/scenejs.box',
        'scenejs/scenejs.video'
    ],
            function () {

                require([
                    'app/nexus'
                ],
                        function (Nexus) {
                            ok(new Nexus({
                                typeLoader:function (type, ok, error) {
                                    require(["../../content/components/objects/" + type], ok, error);
                                }
                            }));
                        });
            });
}

/* Logs errors from nexus
 */
function bindNexusErrors(nexus) {
    nexus.subscribe(
            "error",
            function (error) {
                //alert(JSON.stringify(error));
            });
}


/* Initialises the terminal and binds nexus output and errors notifications
 * so that they are displayed in the terminal
 */
function initTerminal(nexus, $) {

    var dataEcho = false;

    var tilda = $('#tilda').tilda(
            function (command, terminal) {

                if (!dataEcho) {

                    nexus.subscribe("data",
                            function (params) { // Echo action responses
                                if (params) {
                                    terminal.echo(JSON.stringify(params, null, 4)).css("color", "green");
                                }
                            });

                    nexus.subscribe("error",
                            function (params) { // Echo action responses
                                if (params) {
                                    terminal.echo(params.error).css("color", "red");
                                }
                            });

                    dataEcho = true;
                }

                try {
                    eval(command);
                } catch (e) {
                    terminal.echo("uncaught exception: " + (e.message || e) + " - check browser console").css("color", "red");
                }
            });
}

function initTaskMonitor(nexus) {

    var monitor = $("#nexus-taskmonitor");

    if (!monitor) {
        throw "could not find task monitor element";
    }

    var tasks = {};

    nexus.subscribe("task.started",
            function (params) {

                var taskId = params.taskId;
                var description = params.description;

                var elementId = "taskmonitor-" + taskId;

                var taskElement = $("<p id='" + elementId + "'>" + description + "</p>");

                tasks[taskId] = {
                    description:description,
                    element:taskElement
                };

                monitor.append(taskElement);

                taskElement.fadeIn("slow");
            });

    nexus.subscribe("task.finished", taskFinished);
    nexus.subscribe("task.failed", taskFailed);
    nexus.subscribe("task.aborted", taskAborted);

    function taskFinished(params) {
        var taskId = params.taskId;
        var task = tasks[taskId];
        if (task) {
            task.element.css("color", "green");
            task.element.css('background-image', 'url(images/tick-icon.png)');

            delete tasks[taskId];

            setTimeout(
                    function () {

                        task.element.css("color", "green");
                        task.element.css('background-image', 'url(images/tick-icon.png)');

//                        task.element.fadeOut(2000,
//                                function () {

                        setTimeout(
                                function () {
                                    task.element.remove();
                                }, 2000);


                        //}, 2000);
                    });
        }
    }

    function taskFailed(params) {
        var taskId = params.taskId;
        var task = tasks[taskId];
        if (task) {
            task.element.css("color", "red");
        }
    }

    function taskAborted(params) {
        var taskId = params.taskId;
        var task = tasks[taskId];
        if (task) {
            task.element.css("color", "yellow");
        }
    }
}

function initAbout(params) {
    if (params.script) {
        var bootScriptPath = "content/scripts/" + params.script + ".js";
        $("#about-boot-script-name").html("<a href='" + bootScriptPath + "' target='_other'>" + params.script + ".js</a>");
        $("#path-file").html("<a href='" + bootScriptPath + "' target='_other'>" + params.script + ".js</a>");

    } else {
        $("#about-boot-script-name").html("(no script selected)");
        $("#path-file").html("(no script selected)");
    }
}

function updateAbout(params) {
    $("#about-message").html("<h3 class='ready'>ready - click to start</h3>");
    $("#about").click(
            function () {
                $("#about").bPopup().close();
            });
}

function initMenu() {
    $("#about-button").click(function () {
        $("#about").bPopup({
            //  modalClose: false
        });
    });
}


</script>
</body>
</html>